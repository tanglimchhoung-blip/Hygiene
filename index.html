<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Internal ERP</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#101a2f;
      --panel2:#0f1a30;
      --text:#e7eefc;
      --muted:#98a8c7;
      --line:#223256;
      --good:#4ade80;
      --bad:#fb7185;
      --warn:#fbbf24;
      --btn:#2563eb;
      --btn2:#0ea5e9;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:linear-gradient(180deg,#070c16,#0b1220 45%,#070c16);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", sans-serif;
    }
    header{
      padding:18px 16px;
      border-bottom:1px solid var(--line);
      position:sticky; top:0;
      background:rgba(11,18,32,0.88);
      backdrop-filter: blur(10px);
      z-index:10;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:0 12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    h1{font-size:18px;margin:0;font-weight:700}
    .pill{
      font-size:12px;color:var(--muted);
      padding:6px 10px;border:1px solid var(--line);border-radius:999px;
      background:rgba(16,26,47,0.6);
      white-space:nowrap;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.15fr 0.85fr;
      gap:12px;
      padding:12px 0 22px;
    }
    @media (max-width: 960px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background:rgba(16,26,47,0.75);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:0 12px 30px rgba(0,0,0,0.35);
      overflow:hidden;
    }
    .card h2{
      margin:0;
      font-size:14px;
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      background:rgba(15,26,48,0.7);
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;
    }
    .card .body{padding:12px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{
      border:1px solid var(--line);
      background:rgba(16,26,47,0.6);
      color:var(--muted);
      padding:8px 10px;border-radius:12px;
      cursor:pointer;
      font-size:13px;
      user-select:none;
    }
    .tab.active{
      color:var(--text);
      border-color:#2f4a86;
      background:rgba(37,99,235,0.15);
    }
    .section{display:none}
    .section.active{display:block}

    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .form{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:10px;
    }
    .col-12{grid-column:span 12}
    .col-8{grid-column:span 8}
    .col-6{grid-column:span 6}
    .col-4{grid-column:span 4}
    .col-3{grid-column:span 3}
    .col-2{grid-column:span 2}
    @media (max-width: 720px){
      .col-8,.col-6,.col-4,.col-3,.col-2{grid-column:span 12}
    }

    /* Inputs: no overlay, clean numeric, smaller digits */
    input, select, textarea{
      width:100%;
      border:1px solid var(--line);
      background:rgba(9,14,26,0.65);
      color:var(--text);
      border-radius:12px;
      padding:10px 10px;
      font-size:13px;
      outline:none;
      line-height:1.2;
    }
    input.num{
      font-size:12px;               /* smaller number font */
      font-variant-numeric: tabular-nums;
      letter-spacing: 0.2px;
    }
    input:focus, select:focus, textarea:focus{
      border-color:#3b82f6;
      box-shadow:0 0 0 3px rgba(59,130,246,0.20);
    }
    /* Remove number spinners */
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button{
      -webkit-appearance:none; margin:0;
    }
    input[type=number]{ -moz-appearance:textfield; }

    .btns{display:flex;gap:8px;flex-wrap:wrap}
    button{
      border:0;
      background:var(--btn);
      color:#fff;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
    }
    button.secondary{background:rgba(14,165,233,0.18); border:1px solid rgba(14,165,233,0.35)}
    button.ghost{background:transparent;border:1px solid var(--line);color:var(--text)}
    button.danger{background:rgba(251,113,133,0.18);border:1px solid rgba(251,113,133,0.35)}
    button:disabled{opacity:0.55;cursor:not-allowed}

    .log{
      border:1px solid var(--line);
      background:rgba(9,14,26,0.55);
      border-radius:14px;
      padding:10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      color:#cfe2ff;
      white-space:pre-wrap;
      max-height: 360px;
      overflow:auto;
    }
    .statusline{
      display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
      margin-bottom:10px;
    }
    .badge{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);color:var(--muted)}
    .badge.good{border-color:rgba(74,222,128,0.35);color:var(--good);background:rgba(74,222,128,0.10)}
    .badge.bad{border-color:rgba(251,113,133,0.35);color:var(--bad);background:rgba(251,113,133,0.10)}
    .help{font-size:12px;color:var(--muted);margin-top:6px}
    .small{font-size:12px;color:var(--muted)}
    .divider{height:1px;background:var(--line);margin:12px 0}
    .kpi{
      display:grid;grid-template-columns:repeat(3,1fr);gap:10px;
    }
    @media (max-width:720px){ .kpi{grid-template-columns:1fr} }
    .kpi .box{
      border:1px solid var(--line);
      background:rgba(9,14,26,0.45);
      border-radius:14px;
      padding:10px;
    }
    .kpi .title{font-size:12px;color:var(--muted)}
    .kpi .val{font-size:18px;font-weight:800;margin-top:4px;font-variant-numeric: tabular-nums}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <h1>Internal ERP</h1>
        <span class="pill">Google Sheets + Apps Script backend</span>
      </div>
      <div class="row">
        <span class="pill">FX: 2 decimals</span>
        <span class="pill" id="apiPill">API: not tested</span>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">

    <!-- LEFT: App -->
    <div class="card">
      <h2>
        <span>Operations</span>
        <div class="tabs" id="tabs">
          <div class="tab active" data-tab="purchase">Purchase</div>
          <div class="tab" data-tab="sales">Sales</div>
          <div class="tab" data-tab="expenses">Expenses</div>
          <div class="tab" data-tab="reports">Reports</div>
          <div class="tab" data-tab="inventory">Inventory</div>
        </div>
      </h2>

      <div class="body">

        <!-- Purchase -->
        <section class="section active" id="purchase">
          <div class="statusline">
            <span class="badge" id="poBadge">PO: none</span>
            <div class="btns">
              <button class="ghost" id="btnPing">Test API</button>
              <button class="ghost" id="btnClear">Clear Form</button>
            </div>
          </div>

          <div class="form">
            <div class="col-4">
              <label>PO Date</label>
              <input id="po_date" type="date" />
            </div>
            <div class="col-4">
              <label>Supplier</label>
              <input id="po_supplier" placeholder="Supplier name" />
            </div>
            <div class="col-2">
              <label>FX Rate (RMB per USD)</label>
              <input id="po_fx" class="num" type="number" step="0.01" placeholder="7.20" />
              <div class="help">Always 2 decimals</div>
            </div>
            <div class="col-2">
              <label>Shipping (USD)</label>
              <input id="po_ship" class="num" type="number" step="0.01" placeholder="0.00" />
            </div>

            <div class="col-12 btns">
              <button id="btnCreatePO">Create Purchase Header</button>
              <button class="secondary" id="btnAddPOLine" disabled>Add Purchase Line</button>
              <button class="secondary" id="btnPostPO" disabled>Post PO → Inventory</button>
            </div>

            <div class="col-12 divider"></div>

            <div class="col-4">
              <label>SKU</label>
              <input id="po_sku" placeholder="e.g., HY-SPRAY-500-PINK" />
            </div>
            <div class="col-3">
              <label>Qty</label>
              <input id="po_qty" class="num" type="number" step="1" placeholder="10" />
            </div>
            <div class="col-3">
              <label>RMB Unit Price</label>
              <input id="po_rmb_unit" class="num" type="number" step="0.01" placeholder="12.50" />
            </div>
            <div class="col-2">
              <label>Location</label>
              <input id="po_loc" value="MAIN" />
            </div>

            <div class="col-12 small">
              Flow: create header → add lines → post to inventory (IN). Shipping cost is allocated by your Sheet formulas.
            </div>
          </div>
        </section>

        <!-- Sales -->
        <section class="section" id="sales">
          <div class="statusline">
            <span class="badge" id="soBadge">SO: none</span>
            <div class="btns">
              <button class="ghost" id="btnClearSO">Clear Form</button>
            </div>
          </div>

          <div class="form">
            <div class="col-4">
              <label>SO Date</label>
              <input id="so_date" type="date" />
            </div>
            <div class="col-4">
              <label>Customer</label>
              <input id="so_customer" placeholder="Customer name" />
            </div>
            <div class="col-4">
              <label>Location</label>
              <input id="so_loc" value="MAIN" />
            </div>

            <div class="col-12 btns">
              <button id="btnCreateSO">Create Sales Order</button>
              <button class="secondary" id="btnAddSOLine" disabled>Add Sales Line</button>
              <button class="danger" id="btnShipSO" disabled>Ship (FIFO)</button>
            </div>

            <div class="col-12 divider"></div>

            <div class="col-4">
              <label>SKU</label>
              <input id="so_sku" placeholder="e.g., HY-SPRAY-500-PINK" />
            </div>
            <div class="col-3">
              <label>Qty</label>
              <input id="so_qty" class="num" type="number" step="1" placeholder="1" />
            </div>
            <div class="col-3">
              <label>Sell Price (USD)</label>
              <input id="so_price" class="num" type="number" step="0.01" placeholder="5.00" />
            </div>
            <div class="col-2">
              <label>Ship Date</label>
              <input id="so_ship_date" type="date" />
            </div>

            <div class="col-12 small">
              Ship (FIFO) will reduce inventory and write GL entries (Sales, COGS, Inventory).
            </div>
          </div>
        </section>

        <!-- Expenses -->
        <section class="section" id="expenses">
          <div class="form">
            <div class="col-4">
              <label>Expense Date</label>
              <input id="exp_date" type="date" />
            </div>
            <div class="col-4">
              <label>Category (e.g., Marketing)</label>
              <input id="exp_cat" placeholder="Marketing / Salary / Rent / ..." />
              <div class="help">You can type any category. Later we can link to Chart_of_Accounts.</div>
            </div>
            <div class="col-4">
              <label>Sub Category</label>
              <input id="exp_sub" placeholder="Facebook Ads / Influencer / ..." />
            </div>
            <div class="col-4">
              <label>Amount (USD)</label>
              <input id="exp_amt" class="num" type="number" step="0.01" placeholder="0.00" />
            </div>
            <div class="col-8">
              <label>Note</label>
              <input id="exp_note" placeholder="Optional note" />
            </div>

            <div class="col-12 btns">
              <button id="btnAddExp">Add Expense</button>
            </div>
          </div>
        </section>

        <!-- Reports -->
        <section class="section" id="reports">
          <div class="form">
            <div class="col-6">
              <label>Reports_PnL From Date (set in Sheet A2)</label>
              <input id="r_from" type="date" />
              <div class="help">This UI does NOT write dates to sheet yet. Set A2/B2 in Reports_PnL first.</div>
            </div>
            <div class="col-6">
              <label>Reports_PnL To Date (set in Sheet B2)</label>
              <input id="r_to" type="date" />
            </div>

            <div class="col-12 btns">
              <button id="btnGenReports">Generate Reports</button>
            </div>

            <div class="divider"></div>

            <div class="kpi">
              <div class="box">
                <div class="title">Sales</div>
                <div class="val" id="kpiSales">—</div>
              </div>
              <div class="box">
                <div class="title">Net Profit</div>
                <div class="val" id="kpiNet">—</div>
              </div>
              <div class="box">
                <div class="title">Marketing Expense</div>
                <div class="val" id="kpiMkt">—</div>
              </div>
            </div>

            <div class="help" style="margin-top:10px">
              After “Generate Reports”, check tabs: Reports_PnL, Reports_BS, Dashboard in Google Sheets.
            </div>
          </div>
        </section>

        <!-- Inventory -->
        <section class="section" id="inventory">
          <div class="form">
            <div class="col-12 btns">
              <button id="btnInv">Refresh On-hand</button>
            </div>
            <div class="col-12">
              <div class="log" id="invLog">Click “Refresh On-hand” to view inventory by SKU.</div>
            </div>
          </div>
        </section>

      </div>
    </div>

    <!-- RIGHT: Console -->
    <div class="card">
      <h2>
        <span>Console</span>
        <span class="pill" id="lastAction">Ready</span>
      </h2>
      <div class="body">
        <div class="small" style="margin-bottom:8px">
          Backend URL (Apps Script):
          <div class="pill" style="display:inline-block;margin-left:6px" id="apiUrlPill"></div>
        </div>
        <div class="log" id="log"></div>
      </div>
    </div>

  </div>
</main>

<script>
  // ✅ Your Apps Script Web App URL
  const API_URL = "https://script.google.com/macros/s/AKfycbwYLqU1MhrhL3dy3A4HZZDN-9Tifs7iDNB26jg8XiJIg2e_LogxAljN5sUbgEhD9FA/exec";

  // ---------- UI helpers ----------
  const $ = (id) => document.getElementById(id);
  const logEl = $("log");
  const apiPill = $("apiPill");
  const lastAction = $("lastAction");
  $("apiUrlPill").textContent = API_URL;

  function setTodayDefaults(){
    const today = new Date();
    const iso = today.toISOString().slice(0,10);
    if(!$("po_date").value) $("po_date").value = iso;
    if(!$("so_date").value) $("so_date").value = iso;
    if(!$("so_ship_date").value) $("so_ship_date").value = iso;
    if(!$("exp_date").value) $("exp_date").value = iso;
  }
  setTodayDefaults();

  function fmt2(n){
    const x = Number(n);
    if(!isFinite(x)) return "";
    return (Math.round(x*100)/100).toFixed(2);
  }

  function appendLog(obj){
    const t = new Date().toISOString();
    const msg = (typeof obj === "string") ? obj : JSON.stringify(obj, null, 2);
    logEl.textContent = `[${t}]\n${msg}\n\n` + logEl.textContent;
  }

  // ---------- Safe fetch wrapper (avoids failed fetch) ----------
  async function apiCall(action, data={}, {timeoutMs=15000, retries=1} = {}){
    lastAction.textContent = action;

    const payload = JSON.stringify({ action, data });

    for(let attempt=0; attempt<=retries; attempt++){
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), timeoutMs);

      try{
        const res = await fetch(API_URL, {
          method: "POST",
          // IMPORTANT: text/plain avoids preflight in most cases
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: payload,
          signal: controller.signal,
        });

        clearTimeout(timer);

        // Apps Script sometimes returns 200 with JSON error body. Always parse.
        const text = await res.text();
        let json;
        try { json = JSON.parse(text); } catch { json = { ok:false, raw:text }; }

        if(!res.ok){
          throw new Error(`HTTP ${res.status}: ${text.slice(0,200)}`);
        }

        if(!json.ok){
          throw new Error(json.error || "Unknown backend error");
        }

        return json;

      } catch(err){
        clearTimeout(timer);
        if(attempt < retries){
          appendLog({ warn: "request failed, retrying", attempt, error: String(err) });
          await new Promise(r => setTimeout(r, 500));
          continue;
        }
        throw err;
      }
    }
  }

  // ---------- Tabs ----------
  document.querySelectorAll(".tab").forEach(tab=>{
    tab.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
      document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
      tab.classList.add("active");
      $(tab.dataset.tab).classList.add("active");
    });
  });

  // ---------- State ----------
  let currentPO = null;
  let currentSO = null;

  // ---------- Buttons ----------
  $("btnPing").addEventListener("click", async ()=>{
    try{
      const res = await fetch(API_URL + "?action=ping");
      const json = await res.json();
      apiPill.textContent = "API: OK";
      apiPill.style.color = "var(--good)";
      appendLog(json);
    }catch(e){
      apiPill.textContent = "API: ERROR";
      apiPill.style.color = "var(--bad)";
      appendLog({error:String(e)});
    }
  });

  $("btnClear").addEventListener("click", ()=>{
    currentPO = null;
    $("poBadge").textContent = "PO: none";
    $("btnAddPOLine").disabled = true;
    $("btnPostPO").disabled = true;

    ["po_supplier","po_fx","po_ship","po_sku","po_qty","po_rmb_unit"].forEach(id=>$(id).value="");
    setTodayDefaults();
    appendLog("Cleared Purchase form.");
  });

  $("btnCreatePO").addEventListener("click", async ()=>{
    try{
      const fx = fmt2($("po_fx").value);
      if(!fx) return alert("Please input FX rate (e.g. 7.20).");
      const ship = fmt2($("po_ship").value || 0);

      const data = {
        po_date: $("po_date").value,
        supplier: $("po_supplier").value || "",
        fx_rate: Number(fx),
        shipping_usd: Number(ship),
      };

      const out = await apiCall("createPurchaseHeader", data, {retries:1});
      currentPO = out.result.po_id;

      $("poBadge").textContent = "PO: " + currentPO;
      $("poBadge").className = "badge good";
      $("btnAddPOLine").disabled = false;
      $("btnPostPO").disabled = false;

      appendLog(out);

    } catch(e){
      $("poBadge").className = "badge bad";
      appendLog({error:String(e)});
      alert("Create PO failed: " + e.message);
    }
  });

  $("btnAddPOLine").addEventListener("click", async ()=>{
    try{
      if(!currentPO) return alert("Create PO header first.");
      const sku = $("po_sku").value.trim();
      const qty = Number($("po_qty").value);
      const unit = Number($("po_rmb_unit").value);

      if(!sku) return alert("SKU is required.");
      if(!qty || qty<=0) return alert("Qty must be > 0.");
      if(isNaN(unit) || unit<0) return alert("RMB unit price must be >= 0.");

      const out = await apiCall("addPurchaseLine", {
        po_id: currentPO,
        sku,
        qty,
        rmb_unit_price: unit
      }, {retries:1});

      appendLog(out);
      // keep SKU/qty/unit for rapid entry? up to you. we'll clear qty+unit only.
      $("po_qty").value = "";
      $("po_rmb_unit").value = "";

    } catch(e){
      appendLog({error:String(e)});
      alert("Add PO line failed: " + e.message);
    }
  });

  $("btnPostPO").addEventListener("click", async ()=>{
    try{
      if(!currentPO) return alert("Create PO header first.");
      const loc = $("po_loc").value || "MAIN";
      const out = await apiCall("postPurchaseToInventory", {
        po_id: currentPO,
        location: loc
      }, {retries:1});

      appendLog(out);
      alert(`Posted to Inventory. Rows: ${out.result.posted_rows}`);

    } catch(e){
      appendLog({error:String(e)});
      alert("Post to inventory failed: " + e.message + "\n\nTip: Check Purchase_Lines formulas (landed_unit_cost_usd must not be blank).");
    }
  });

  // Sales
  $("btnClearSO").addEventListener("click", ()=>{
    currentSO = null;
    $("soBadge").textContent = "SO: none";
    $("soBadge").className = "badge";
    $("btnAddSOLine").disabled = true;
    $("btnShipSO").disabled = true;
    ["so_customer","so_sku","so_qty","so_price"].forEach(id=>$(id).value="");
    setTodayDefaults();
    appendLog("Cleared Sales form.");
  });

  $("btnCreateSO").addEventListener("click", async ()=>{
    try{
      const data = {
        so_date: $("so_date").value,
        customer: $("so_customer").value || "",
        status: "DRAFT"
      };
      const out = await apiCall("createSalesOrderHeader", data, {retries:1});
      currentSO = out.result.so_id;

      $("soBadge").textContent = "SO: " + currentSO;
      $("soBadge").className = "badge good";
      $("btnAddSOLine").disabled = false;
      $("btnShipSO").disabled = false;
      appendLog(out);

    } catch(e){
      $("soBadge").className = "badge bad";
      appendLog({error:String(e)});
      alert("Create SO failed: " + e.message);
    }
  });

  $("btnAddSOLine").addEventListener("click", async ()=>{
    try{
      if(!currentSO) return alert("Create SO header first.");
      const sku = $("so_sku").value.trim();
      const qty = Number($("so_qty").value);
      const price = Number($("so_price").value);

      if(!sku) return alert("SKU is required.");
      if(!qty || qty<=0) return alert("Qty must be > 0.");
      if(isNaN(price) || price<0) return alert("Sell price must be >= 0.");

      const out = await apiCall("addSalesOrderLine", {
        so_id: currentSO,
        sku,
        qty,
        sell_price_usd: price
      }, {retries:1});

      appendLog(out);
      $("so_qty").value = "";
      $("so_price").value = "";

    } catch(e){
      appendLog({error:String(e)});
      alert("Add SO line failed: " + e.message);
    }
  });

  $("btnShipSO").addEventListener("click", async ()=>{
    try{
      if(!currentSO) return alert("Create SO header first.");
      const loc = $("so_loc").value || "MAIN";
      const shipDate = $("so_ship_date").value;

      const out = await apiCall("shipSalesOrder", {
        so_id: currentSO,
        ship_date: shipDate,
        location: loc
      }, {retries:1});

      appendLog(out);
      alert(`Shipped.\nRevenue: ${fmt2(out.result.revenue_usd)}\nCOGS: ${fmt2(out.result.cogs_usd)}\nGross Profit: ${fmt2(out.result.gross_profit_usd)}`);

    } catch(e){
      appendLog({error:String(e)});
      alert("Ship failed: " + e.message + "\n\nTip: If it says not enough inventory, post purchase to inventory first.");
    }
  });

  // Expenses
  $("btnAddExp").addEventListener("click", async ()=>{
    try{
      const amt = Number($("exp_amt").value);
      if(isNaN(amt) || amt < 0) return alert("Amount must be >= 0.");

      const out = await apiCall("addOperatingExpense", {
        exp_date: $("exp_date").value,
        category: $("exp_cat").value || "",
        sub_category: $("exp_sub").value || "",
        amount_usd: amt,
        note: $("exp_note").value || ""
      }, {retries:1});

      appendLog(out);
      $("exp_amt").value = "";
      $("exp_note").value = "";
      alert("Expense saved.");

    } catch(e){
      appendLog({error:String(e)});
      alert("Add expense failed: " + e.message);
    }
  });

  // Reports
  $("btnGenReports").addEventListener("click", async ()=>{
    try{
      const out = await apiCall("generateReports", {}, {retries:1});
      appendLog(out);

      $("kpiSales").textContent = fmt2(out.result.sales);
      $("kpiNet").textContent = fmt2(out.result.net_profit);
      $("kpiMkt").textContent = fmt2((out.result.marketing_expense || out.result.marketing || 0) || 0); // fallback

      // Your backend returns marketing from dashboard calculation only in sheet.
      // We'll show Marketing = (not available from API) => 0 unless you later extend API.
      // For now display from result if present.
      if(out.result && typeof out.result.net_profit !== "undefined"){
        $("kpiNet").textContent = fmt2(out.result.net_profit);
      }
      // If API doesn’t return marketing, show 0.00 (we can add it later).
      if(!("marketing_expense" in out.result) && !("marketing" in out.result)){
        $("kpiMkt").textContent = "0.00";
      }

      alert("Reports generated. Please check your Google Sheet tabs: Reports_PnL, Reports_BS, Dashboard.");

    } catch(e){
      appendLog({error:String(e)});
      alert("Generate reports failed: " + e.message + "\n\nTip: Set Reports_PnL!A2 and B2 dates first.");
    }
  });

  // Inventory
  $("btnInv").addEventListener("click", async ()=>{
    try{
      const out = await apiCall("getInventoryOnHand", {}, {retries:1});
      appendLog(out);

      const map = out.result.on_hand || {};
      const lines = Object.keys(map).sort().map(sku => `${sku}: ${map[sku]}`).join("\n");
      $("invLog").textContent = lines || "(no inventory yet)";

    } catch(e){
      appendLog({error:String(e)});
      alert("Inventory refresh failed: " + e.message);
    }
  });

  // Auto test API once on load
  (async ()=>{
    try{
      const res = await fetch(API_URL + "?action=ping");
      const json = await res.json();
      apiPill.textContent = "API: OK";
      apiPill.style.color = "var(--good)";
      appendLog(json);
    }catch(e){
      apiPill.textContent = "API: ERROR";
      apiPill.style.color = "var(--bad)";
      appendLog({error:String(e)});
    }
  })();
</script>
</body>
</html>

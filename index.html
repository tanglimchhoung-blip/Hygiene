<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Internal ERP</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --line:#e5e7eb;
      --text:#111827;
      --muted:#6b7280;
      --primary:#2563eb;
      --primary2:#0ea5e9;
      --danger:#ef4444;
      --good:#16a34a;
      --shadow:0 10px 30px rgba(17,24,39,.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg);
      color:var(--text);
    }
    header{
      position:sticky;top:0;z-index:10;
      background:rgba(255,255,255,.88);
      backdrop-filter:blur(10px);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:0 14px}
    .top{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 0;gap:12px;flex-wrap:wrap
    }
    .brand{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    h1{margin:0;font-size:18px;font-weight:900}
    .pill{
      padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      background:#fff;color:var(--muted);font-size:12px;white-space:nowrap
    }
    .pill.good{border-color:rgba(22,163,74,.25);background:rgba(22,163,74,.08);color:var(--good)}
    .pill.bad{border-color:rgba(239,68,68,.25);background:rgba(239,68,68,.08);color:var(--danger)}
    main{padding:16px 0 28px}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card h2{
      margin:0;
      padding:12px 14px;
      font-size:14px;
      border-bottom:1px solid var(--line);
      background:#fff;
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .body{padding:14px}

    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{
      cursor:pointer;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--muted);
      font-size:13px;
      user-select:none;
    }
    .tab.active{
      color:var(--text);
      border-color:rgba(37,99,235,.35);
      background:rgba(37,99,235,.08);
    }

    .section{display:none}
    .section.active{display:block}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}

    .chip{
      font-size:12px;
      padding:6px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:#fff;
      color:var(--muted);
    }

    .step{
      border:1px solid var(--line);
      background:#fff;
      border-radius:14px;
      padding:12px;
      margin-bottom:12px;
    }
    .stepTitle{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin-bottom:10px;flex-wrap:wrap
    }
    .hint{font-size:12px;color:var(--muted);margin-top:6px}

    .form{
      display:grid;
      grid-template-columns:repeat(12,1fr);
      gap:10px;
      align-items:end;
    }
    .col-12{grid-column:span 12}
    .col-6{grid-column:span 6}
    .col-4{grid-column:span 4}
    .col-3{grid-column:span 3}
    .col-2{grid-column:span 2}
    @media(max-width:720px){
      .col-6,.col-4,.col-3,.col-2{grid-column:span 12}
    }

    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input{
      width:100%;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      border-radius:12px;
      padding:10px;
      font-size:13px;
      outline:none;
      line-height:1.2;
    }
    input.num{font-size:12px;font-variant-numeric:tabular-nums}
    input:focus{
      border-color:rgba(37,99,235,.45);
      box-shadow:0 0 0 3px rgba(37,99,235,.14);
    }
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
    input[type=number]{ -moz-appearance:textfield; }

    .btns{display:flex;gap:8px;flex-wrap:wrap}
    button{
      border:0;
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      color:#fff;
      background:var(--primary);
    }
    button.secondary{
      background:rgba(14,165,233,.12);
      color:#075985;
      border:1px solid rgba(14,165,233,.35);
    }
    button.ghost{
      background:#fff;
      color:var(--text);
      border:1px solid var(--line);
    }
    button.danger{
      background:rgba(239,68,68,.10);
      color:#991b1b;
      border:1px solid rgba(239,68,68,.30);
    }
    button:disabled{opacity:.55;cursor:not-allowed}

    .kpi{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:10px;
      margin-top:10px;
    }
    @media(max-width:720px){.kpi{grid-template-columns:1fr}}
    .kbox{
      border:1px solid var(--line);
      background:#fff;
      border-radius:14px;
      padding:10px;
    }
    .kbox .t{font-size:12px;color:var(--muted)}
    .kbox .v{font-size:18px;font-weight:900;margin-top:4px;font-variant-numeric:tabular-nums}

    .monoBox{
      border:1px solid var(--line);
      background:#fff;
      border-radius:14px;
      padding:10px;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:12px;
      white-space:pre-wrap;
      max-height:260px;
      overflow:auto;
      color:#111827;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1>Internal ERP</h1>
        <span class="pill">Google Sheets + Apps Script</span>
      </div>
      <div class="btns">
        <span class="pill">FX: 2 decimals</span>
        <span class="pill" id="apiStatus">API: not tested</span>
        <button class="ghost" id="btnPing" type="button">Test API</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <div class="card">
      <h2>
        <span>Operations</span>
        <div class="tabs">
          <div class="tab active" data-tab="purchase">Purchase</div>
          <div class="tab" data-tab="sales">Sales</div>
          <div class="tab" data-tab="expenses">Expenses</div>
          <div class="tab" data-tab="reports">Reports</div>
          <div class="tab" data-tab="inventory">Inventory</div>
        </div>
      </h2>

      <div class="body">
        <div class="row" style="margin-bottom:10px;">
          <div class="btns">
            <span class="chip" id="poChip">PO: (none)</span>
            <span class="chip" id="soChip">SO: (none)</span>
          </div>
          <div class="btns">
            <button class="ghost" id="btnClear" type="button">Clear Form</button>
          </div>
        </div>

        <!-- PURCHASE -->
        <section class="section active" id="purchase">
          <div class="step">
            <div class="stepTitle">
              <strong>Purchase</strong>
              <span class="chip">Flow: Header → Lines → Post to Inventory</span>
            </div>

            <div class="form">
              <div class="col-4">
                <label>PO Date</label>
                <input id="po_date" type="date"/>
              </div>
              <div class="col-4">
                <label>Supplier</label>
                <input id="po_supplier" placeholder="Supplier name"/>
              </div>
              <div class="col-2">
                <label>FX (RMB per USD)</label>
                <input id="po_fx" class="num" type="number" step="0.01" min="0.01" placeholder="7.20"/>
              </div>
              <div class="col-2">
                <label>Shipping (USD)</label>
                <input id="po_ship" class="num" type="number" step="0.01" min="0" placeholder="0.00"/>
              </div>

              <div class="col-12 btns">
                <button id="btnCreatePO" type="button">Create Purchase Header</button>
                <button class="ghost" id="btnNewPO" type="button">New PO</button>
              </div>
              <div class="col-12 hint">FX is saved with 2 decimals. Shipping allocation is calculated by your Sheet formulas.</div>
            </div>
          </div>

          <div class="step">
            <div class="stepTitle">
              <strong>Purchase Lines</strong>
              <span class="chip">Add SKU lines under current PO</span>
            </div>

            <div class="form">
              <div class="col-4">
                <label>SKU</label>
                <input id="po_sku" placeholder="e.g., HY-SPRAY-500-PINK"/>
              </div>
              <div class="col-3">
                <label>Qty</label>
                <input id="po_qty" class="num" type="number" step="1" min="1" placeholder="10"/>
              </div>
              <div class="col-3">
                <label>RMB Unit Price</label>
                <input id="po_rmb_unit" class="num" type="number" step="0.01" min="0" placeholder="12.50"/>
              </div>
              <div class="col-2">
                <label>Location</label>
                <input id="po_loc" value="MAIN"/>
              </div>

              <div class="col-12 btns">
                <button class="secondary" id="btnAddPOLine" type="button" disabled>Add Purchase Line</button>
                <button class="secondary" id="btnPostPO" type="button" disabled>Post PO → Inventory</button>
              </div>
            </div>
          </div>

          <div class="step">
            <div class="stepTitle">
              <strong>Status</strong>
              <span class="chip">Last response</span>
            </div>
            <div class="monoBox" id="statusBox">No actions yet.</div>
          </div>
        </section>

        <!-- SALES -->
        <section class="section" id="sales">
          <div class="step">
            <div class="stepTitle">
              <strong>Sales</strong>
              <span class="chip">Flow: SO → Lines → Ship (FIFO)</span>
            </div>

            <div class="form">
              <div class="col-4">
                <label>SO Date</label>
                <input id="so_date" type="date"/>
              </div>
              <div class="col-4">
                <label>Customer</label>
                <input id="so_customer" placeholder="Customer name"/>
              </div>
              <div class="col-4">
                <label>Location</label>
                <input id="so_loc" value="MAIN"/>
              </div>

              <div class="col-12 btns">
                <button id="btnCreateSO" type="button">Create Sales Order</button>
                <button class="ghost" id="btnNewSO" type="button">New SO</button>
              </div>
            </div>
          </div>

          <div class="step">
            <div class="stepTitle">
              <strong>Sales Lines + Shipping</strong>
              <span class="chip">Ship writes Inventory OUT</span>
            </div>

            <div class="form">
              <div class="col-4">
                <label>SKU</label>
                <input id="so_sku" placeholder="e.g., HY-SPRAY-500-PINK"/>
              </div>
              <div class="col-3">
                <label>Qty</label>
                <input id="so_qty" class="num" type="number" step="1" min="1" placeholder="1"/>
              </div>
              <div class="col-3">
                <label>Sell Price (USD)</label>
                <input id="so_price" class="num" type="number" step="0.01" min="0" placeholder="5.00"/>
              </div>
              <div class="col-2">
                <label>Ship Date</label>
                <input id="so_ship_date" type="date"/>
              </div>

              <div class="col-12 btns">
                <button class="secondary" id="btnAddSOLine" type="button" disabled>Add Sales Line</button>
                <button class="danger" id="btnShipSO" type="button" disabled>Ship (FIFO)</button>
              </div>
            </div>
          </div>

          <div class="step">
            <div class="stepTitle">
              <strong>Status</strong>
              <span class="chip">Last response</span>
            </div>
            <div class="monoBox" id="statusBox2">No actions yet.</div>
          </div>
        </section>

        <!-- EXPENSES -->
        <section class="section" id="expenses">
          <div class="step">
            <div class="stepTitle">
              <strong>Operating Expenses</strong>
              <span class="chip">Unlimited categories</span>
            </div>

            <div class="form">
              <div class="col-4">
                <label>Date</label>
                <input id="exp_date" type="date"/>
              </div>
              <div class="col-4">
                <label>Category</label>
                <input id="exp_cat" placeholder="Marketing / Salary / Rent / ..."/>
              </div>
              <div class="col-4">
                <label>Sub Category</label>
                <input id="exp_sub" placeholder="Facebook Ads / Influencer / ..."/>
              </div>
              <div class="col-4">
                <label>Amount (USD)</label>
                <input id="exp_amt" class="num" type="number" step="0.01" min="0" placeholder="0.00"/>
              </div>
              <div class="col-8">
                <label>Note</label>
                <input id="exp_note" placeholder="Optional"/>
              </div>

              <div class="col-12 btns">
                <button id="btnAddExp" type="button">Save Expense</button>
              </div>
              <div class="col-12 hint">Tip: Put “Marketing” in Category to show in marketing KPI later.</div>
            </div>
          </div>
        </section>

        <!-- REPORTS -->
        <section class="section" id="reports">
          <div class="step">
            <div class="stepTitle">
              <strong>Reports + Dashboard</strong>
              <span class="chip">Select date here (From/To)</span>
            </div>

            <div class="form">
              <div class="col-4">
                <label>From Date</label>
                <input id="rep_from" type="date"/>
              </div>
              <div class="col-4">
                <label>To Date</label>
                <input id="rep_to" type="date"/>
              </div>
              <div class="col-4 btns">
                <button id="btnGenReports" type="button">Generate</button>
                <button class="ghost" id="btnRefreshKpi" type="button">Refresh KPI</button>
              </div>
            </div>

            <div class="kpi">
              <div class="kbox">
                <div class="t">Sales</div>
                <div class="v" id="kpiSales">—</div>
              </div>
              <div class="kbox">
                <div class="t">Net Profit</div>
                <div class="v" id="kpiNet">—</div>
              </div>
              <div class="kbox">
                <div class="t">Marketing</div>
                <div class="v" id="kpiMkt">—</div>
              </div>
            </div>

            <div class="hint">Generate sets Reports_PnL!A2:B2 then pulls KPI from Dashboard (via Apps Script).</div>
          </div>
        </section>

        <!-- INVENTORY -->
        <section class="section" id="inventory">
          <div class="step">
            <div class="stepTitle">
              <strong>Inventory On-hand</strong>
              <span class="chip">By SKU</span>
            </div>

            <div class="btns" style="margin-bottom:10px;">
              <button id="btnInv" type="button">Refresh</button>
            </div>

            <div class="monoBox" id="invBox">Click Refresh to load on-hand by SKU.</div>
          </div>
        </section>

      </div>
    </div>
  </div>
</main>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbwYLqU1MhrhL3dy3A4HZZDN-9Tifs7iDNB26jg8XiJIg2e_LogxAljN5sUbgEhD9FA/exec";

  const $ = (id)=>document.getElementById(id);

  let currentPO = null;
  let currentSO = null;

  function isoToday(){ return new Date().toISOString().slice(0,10); }
  function setDefaults(){
    const iso = isoToday();
    if(!$("po_date").value) $("po_date").value = iso;
    if(!$("so_date").value) $("so_date").value = iso;
    if(!$("so_ship_date").value) $("so_ship_date").value = iso;
    if(!$("exp_date").value) $("exp_date").value = iso;
    if(!$("rep_from").value) $("rep_from").value = iso;
    if(!$("rep_to").value) $("rep_to").value = iso;
  }
  setDefaults();

  function round2(n){
    const x = Number(n);
    if(!isFinite(x)) return "";
    return (Math.round(x*100)/100).toFixed(2);
  }

  function setStatus(boxId, obj){
    const box = $(boxId);
    if(!box) return;
    const t = new Date().toISOString();
    const txt = (typeof obj === "string") ? obj : JSON.stringify(obj, null, 2);
    box.textContent = `[${t}]\n${txt}`;
  }

  async function apiCall(action, data={}, {timeoutMs=15000, retries=1} = {}){
    const payload = JSON.stringify({ action, data });

    for(let attempt=0; attempt<=retries; attempt++){
      const controller = new AbortController();
      const timer = setTimeout(()=>controller.abort(), timeoutMs);

      try{
        const res = await fetch(API_URL, {
          method:"POST",
          headers:{ "Content-Type":"text/plain;charset=utf-8" },
          body: payload,
          signal: controller.signal
        });
        clearTimeout(timer);

        const text = await res.text();
        let json;
        try{ json = JSON.parse(text); }catch{ json = { ok:false, raw:text }; }

        if(!res.ok) throw new Error(`HTTP ${res.status}: ${text.slice(0,200)}`);
        if(!json.ok) throw new Error(json.error || "Backend error");

        return json;

      }catch(err){
        clearTimeout(timer);
        if(attempt < retries){
          await new Promise(r=>setTimeout(r, 450));
          continue;
        }
        throw err;
      }
    }
  }

  function updateChips(){
    $("poChip").textContent = currentPO ? `PO: ${currentPO}` : "PO: (none)";
    $("soChip").textContent = currentSO ? `SO: ${currentSO}` : "SO: (none)";
    $("btnAddPOLine").disabled = !currentPO;
    $("btnPostPO").disabled = !currentPO;
    $("btnCreatePO").disabled = !!currentPO;
    $("btnAddSOLine").disabled = !currentSO;
    $("btnShipSO").disabled = !currentSO;
    $("btnCreateSO").disabled = !!currentSO;
  }
  updateChips();

  // Tabs
  document.querySelectorAll(".tab").forEach(tab=>{
    tab.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
      document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
      tab.classList.add("active");
      $(tab.dataset.tab).classList.add("active");
    });
  });

  // Ping
  $("btnPing").addEventListener("click", async ()=>{
    try{
      const res = await fetch(API_URL + "?action=ping");
      const json = await res.json();
      $("apiStatus").textContent = "API: OK";
      $("apiStatus").className = "pill good";
      setStatus("statusBox", json);
    }catch(e){
      $("apiStatus").textContent = "API: ERROR";
      $("apiStatus").className = "pill bad";
      setStatus("statusBox", {error:String(e)});
    }
  });

  // Clear
  $("btnClear").addEventListener("click", ()=>{
    currentPO = null;
    currentSO = null;
    $("po_supplier").value = "";
    $("po_fx").value = "";
    $("po_ship").value = "";
    $("po_sku").value = "";
    $("po_qty").value = "";
    $("po_rmb_unit").value = "";
    $("po_loc").value = "MAIN";
    $("so_customer").value = "";
    $("so_loc").value = "MAIN";
    $("so_sku").value = "";
    $("so_qty").value = "";
    $("so_price").value = "";
    $("exp_cat").value = "";
    $("exp_sub").value = "";
    $("exp_amt").value = "";
    $("exp_note").value = "";
    setDefaults();
    updateChips();
    setStatus("statusBox", "Cleared.");
    setStatus("statusBox2", "Cleared.");
  });

  // New PO
  $("btnNewPO").addEventListener("click", ()=>{
    currentPO = null;
    $("po_supplier").value = "";
    $("po_fx").value = "";
    $("po_ship").value = "";
    $("po_sku").value = "";
    $("po_qty").value = "";
    $("po_rmb_unit").value = "";
    setDefaults();
    updateChips();
    setStatus("statusBox", "New PO started.");
  });

  // Create PO
  $("btnCreatePO").addEventListener("click", async ()=>{
    try{
      const fxNum = parseFloat(String($("po_fx").value||"").trim());
      if(!isFinite(fxNum) || fxNum<=0) return alert("FX must be > 0 (example: 7.20)");

      const fx = Number(round2(fxNum));
      const shipNum = parseFloat(String($("po_ship").value||"0").trim());
      const ship = isFinite(shipNum) ? Number(round2(shipNum)) : 0;

      const out = await apiCall("createPurchaseHeader", {
        po_date: $("po_date").value || isoToday(),
        supplier: $("po_supplier").value || "",
        fx_rate: fx,
        shipping_usd: ship
      });

      currentPO = out.result.po_id;
      updateChips();
      setStatus("statusBox", out);

    }catch(e){
      setStatus("statusBox", {error:String(e)});
      alert("Create PO failed: " + e.message);
    }
  });

  // Add PO line
  $("btnAddPOLine").addEventListener("click", async ()=>{
    try{
      if(!currentPO) return alert("Create PO header first.");
      const sku = $("po_sku").value.trim();
      const qty = Number($("po_qty").value);
      const unit = Number($("po_rmb_unit").value);

      if(!sku) return alert("SKU is required.");
      if(!isFinite(qty) || qty<=0) return alert("Qty must be > 0.");
      if(!isFinite(unit) || unit<0) return alert("RMB Unit Price must be >= 0.");

      const out = await apiCall("addPurchaseLine", {
        po_id: currentPO,
        sku,
        qty,
        rmb_unit_price: unit
      });

      $("po_qty").value = "";
      $("po_rmb_unit").value = "";
      setStatus("statusBox", out);

    }catch(e){
      setStatus("statusBox", {error:String(e)});
      alert("Add line failed: " + e.message);
    }
  });

  // Post PO
  $("btnPostPO").addEventListener("click", async ()=>{
    try{
      if(!currentPO) return alert("Create PO header first.");
      const out = await apiCall("postPurchaseToInventory", {
        po_id: currentPO,
        location: $("po_loc").value || "MAIN"
      });
      setStatus("statusBox", out);
      alert(`Posted to Inventory. Rows: ${out.result.posted_rows}`);
    }catch(e){
      setStatus("statusBox", {error:String(e)});
      alert("Post failed: " + e.message + "\n\nTip: Make sure Purchase_Lines landed_unit_cost_usd has values (formulas).");
    }
  });

  // New SO
  $("btnNewSO").addEventListener("click", ()=>{
    currentSO = null;
    $("so_customer").value = "";
    $("so_sku").value = "";
    $("so_qty").value = "";
    $("so_price").value = "";
    setDefaults();
    updateChips();
    setStatus("statusBox2", "New SO started.");
  });

  // Create SO
  $("btnCreateSO").addEventListener("click", async ()=>{
    try{
      const out = await apiCall("createSalesOrderHeader", {
        so_date: $("so_date").value || isoToday(),
        customer: $("so_customer").value || "",
        status: "DRAFT"
      });
      currentSO = out.result.so_id;
      updateChips();
      setStatus("statusBox2", out);
    }catch(e){
      setStatus("statusBox2", {error:String(e)});
      alert("Create SO failed: " + e.message);
    }
  });

  // Add SO line
  $("btnAddSOLine").addEventListener("click", async ()=>{
    try{
      if(!currentSO) return alert("Create Sales Order first.");
      const sku = $("so_sku").value.trim();
      const qty = Number($("so_qty").value);
      const price = Number($("so_price").value);

      if(!sku) return alert("SKU is required.");
      if(!isFinite(qty) || qty<=0) return alert("Qty must be > 0.");
      if(!isFinite(price) || price<0) return alert("Sell price must be >= 0.");

      const out = await apiCall("addSalesOrderLine", {
        so_id: currentSO, sku, qty, sell_price_usd: price
      });

      $("so_qty").value = "";
      $("so_price").value = "";
      setStatus("statusBox2", out);

    }catch(e){
      setStatus("statusBox2", {error:String(e)});
      alert("Add sales line failed: " + e.message);
    }
  });

  // Ship SO
  $("btnShipSO").addEventListener("click", async ()=>{
    try{
      if(!currentSO) return alert("Create Sales Order first.");
      const out = await apiCall("shipSalesOrder", {
        so_id: currentSO,
        ship_date: $("so_ship_date").value || isoToday(),
        location: $("so_loc").value || "MAIN"
      });
      setStatus("statusBox2", out);
      alert(`Shipped.\nRevenue: ${round2(out.result.revenue_usd)}\nCOGS: ${round2(out.result.cogs_usd)}\nGross: ${round2(out.result.gross_profit_usd)}`);
    }catch(e){
      setStatus("statusBox2", {error:String(e)});
      alert("Ship failed: " + e.message);
    }
  });

  // Expense
  $("btnAddExp").addEventListener("click", async ()=>{
    try{
      const amt = Number($("exp_amt").value);
      if(!isFinite(amt) || amt<0) return alert("Amount must be >= 0.");

      const out = await apiCall("addOperatingExpense", {
        exp_date: $("exp_date").value || isoToday(),
        category: $("exp_cat").value || "",
        sub_category: $("exp_sub").value || "",
        amount_usd: amt,
        note: $("exp_note").value || ""
      });

      $("exp_amt").value = "";
      $("exp_note").value = "";
      alert("Expense saved.");
      setStatus("statusBox", out);

    }catch(e){
      setStatus("statusBox", {error:String(e)});
      alert("Expense failed: " + e.message);
    }
  });

  // KPI
  async function refreshKpi(){
    const out = await apiCall("getDashboardKpis", {});
    $("kpiSales").textContent = round2(out.result.sales);
    $("kpiNet").textContent = round2(out.result.net_profit);
    $("kpiMkt").textContent = round2(out.result.marketing_expense);
  }

  $("btnGenReports").addEventListener("click", async ()=>{
    try{
      const from = $("rep_from").value || isoToday();
      const to = $("rep_to").value || isoToday();
      await apiCall("setReportDates", { from_date: from, to_date: to });
      await apiCall("generateReports", {});
      await refreshKpi();
      alert("Reports generated + KPI refreshed.");
    }catch(e){
      alert("Generate reports failed: " + e.message);
    }
  });

  $("btnRefreshKpi").addEventListener("click", async ()=>{
    try{ await refreshKpi(); }
    catch(e){ alert("Refresh KPI failed: " + e.message); }
  });

  // Inventory
  $("btnInv").addEventListener("click", async ()=>{
    try{
      const out = await apiCall("getInventoryOnHand", {});
      const map = out.result.on_hand || {};
      const lines = Object.keys(map).sort().map(sku => `${sku}: ${map[sku]}`).join("\n");
      $("invBox").textContent = lines || "(no inventory yet)";
    }catch(e){
      alert("Inventory refresh failed: " + e.message);
    }
  });

  // Auto ping once
  (async ()=>{
    try{
      const res = await fetch(API_URL + "?action=ping");
      const json = await res.json();
      $("apiStatus").textContent = "API: OK";
      $("apiStatus").className = "pill good";
      setStatus("statusBox", json);
    }catch(e){
      $("apiStatus").textContent = "API: ERROR";
      $("apiStatus").className = "pill bad";
      setStatus("statusBox", {error:String(e)});
    }
  })();
</script>
</body>
</html>
